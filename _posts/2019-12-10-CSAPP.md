---
layout: post
title: 深入理解计算机系统CSAPP-美-布莱恩特
date: 2019-12-18
tags: 读书
---

# 深入理解计算机系统CSAPP-美-布莱恩特

## 计算机系统漫游

这一个章节主要从一个hello world程序出发，串联了计算机系统的整个流程。串联路径为：信息就是bit加上下文 => 程序被其他程序翻译成不同格式 => 了解编译系统能让你写出高效安全的代码 => 处理器读并解析存储在内存中的指令 => 总线 => I/O设备 => (人类是复读机，计算机是复制机) => 运行hello程序 => 高速缓存 => 存储设备形成层次，上一个设备是下一个设备的缓存 => 进程 => 线程 => 虚拟内存，虚拟地址空间 => 文件 => 系统之间利用网络通信 => 多核 => 超线程 => 超标量处理器一个时钟周期处理多于一条的指令

## 信息的表示和处理

虚拟内存指的是计算机的内存管理技术，它使得应用程序以为自己在访问一段连续的可用内存，实际上，它访问的内存并不连续，甚至有可能使用磁盘充当内存。

我们所说的32位程序和64位程序，区别在于它是怎么编译的，如```gcc -m32 hello.c```表示它是32位程序，而```gcc -m64 hello.c```表示它是64位程序，需要注意的是，64位程序无法在32位机器上运行，而32位程序可以在32位和64位机器上运行。 

位运算的快捷计算方式：相与取最小，如01&10=00，按位取最小。相或取最大，如01 | 10 = 11。异或做加法，如11 ^ 11 = 00，1+1=0，进位1，舍弃进位。

补码的理解，可以认为补码的第一位是负权，如1000 0000表示的是-1*2^8=-128，比起原补码的理解：负数位取反加1，即000 0000取反为111 1111加1为1000 0000的计算更快。当然，如果计算十进制转二进制的补码形式，还是需要取反加1的。

## 程序的机器级表示

虽然C语言中提供了各种数据类型，但是机器代码只是简单地把内存看成一个很大的数组，并不区分有符号和无符号，不区分各种类型地指针。

程序内存用虚拟地址来寻址，x86-64的虚拟地址是由64位的字来表示，其高16位被置0，所以一地址实际上指定的是2^48=64TB。

汇编产生的机器码从1到15个字节不等，常用的指令和操作数较少的指令会较短。指令格式的设计是唯一的，比如，只有指令pushq %rbx是以字节值53开头的。

连接器的作用是将多个目标文件连接起来，找到主程序调用其他程序的调用地址。

C文件的编译过程：
+ 预编译，include文件展开了：gcc -Og -E -o main.i main.c
+ 编译，编译成了汇编语言：gcc -Og -S main.c
+ 汇编，编译成了机器语言，如果使用objdump反编译，可以看到函数调用是使用偏移量的：gcc -Og -c main.c
+ 链接，反编译后的地址使用的是真实地址：gcc -Og -o prop main.c mstore.c

以上可以看到，预编译，编译和汇编都可以一个文件完成，只有链接才需要多个文件

内存寻址的通用模式为：Imm + R[rb] + R[ri] * s，其中Imm指的是立即数，rb指的是基址寄存器，ri表示变址，s表示比例因子1，2，4，8。引用数组时，会使用这种通用格式。




